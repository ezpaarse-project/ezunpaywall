const { paths, cron } = require('config');

const appLogger = require('../lib/logger/appLogger');
const Cron = require('./cron');

const { deleteFilesInDir } = require('../lib/files');

const cronConfig = cron.cleanFile;

let { active } = cronConfig;
if (active === 'true' || active) active = true;
else active = false;

/**
 * Removes files generated by an update process that are older than 30 days.
 *
 * @returns {Promise<void>}
 */
async function task() {
  appLogger.info('[cron][Clean file]: Has start');
  const deletedChangefiles = await deleteFilesInDir(
    paths.data.changefilesDir,
    cronConfig.changefileThreshold,
  );
  appLogger.info(`[cron][Clean file]: ${deletedChangefiles?.join(',')} (${deletedChangefiles.length}) changefiles are deleted`);

  const deletedReportFiles = await deleteFilesInDir(
    paths.data.reportsDir,
    cronConfig.reportThreshold,
  );
  appLogger.info(`[cron][Clean file]: ${deletedReportFiles?.join(',')} (${deletedReportFiles.length}) reports are deleted`);

  const deletedSnapshotFiles = await deleteFilesInDir(
    paths.data.snapshotsDir,
    cronConfig.snapshotsDir,
  );

  appLogger.info(`[cron][Clean file]: Has finished: ${deletedSnapshotFiles?.join(',')} (${deletedSnapshotFiles.length}) snapshots are deleted`);
}

const deleteFileCron = new Cron('Clean file', cronConfig.schedule, task, active);

module.exports = deleteFileCron;
