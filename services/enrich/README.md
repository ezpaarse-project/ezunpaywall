# ezunpaywall-enrich

Service that enrich csv and jsonl file with unpaywall data.

## Config

To set up this service, you can use environment variables. The config is displayed at startup. Sensitive data are not displayed.

see [default config](./config/default.json)

## Environment variables

### Application

| Name | Description | Default |
| --- | --- | --- |
| NODE_ENV | Environment of node | development |
| TIMEZONE |  Timezone of app used in cron | Europe/Paris |
| ADMIN_APIKEY | Admin API key | changeme |
| HEALTH_TIMEOUT | Timeout to query the health route |  3000 |
| PORT | Port | 3000 |

### Redis

| Name | Description | Default |
| --- | --- | --- |
| REDIS_HOST | Redis host | redis |
| REDIS_PORT | Redis port | 6379 |
| REDIS_PASSWORD | Redis password | changeme |

### Graphql

| Name | Description | Default |
| --- | --- | --- |
| GRAPHQL_URL | Graphql host | http://graphql:3000 |

### Cron

#### Clean File

| Name | Description | Default |
| --- | --- | --- |
| CRON_CLEAN_FILE_SCHEDULE | Schedule of cron | 0 0 0 * * * |
| CRON_CLEAN_FILE_ACTIVE | Cron active or not at the start of service | true |
| CRON_CLEAN_FILE_ENRICHED_RETENTION | Detention time in days for enriched file | 1 |
| CRON_CLEAN_FILE_UPLOADED_RETENTION | Detention time in days for uploaded file | 1 |
| CRON_CLEAN_FILE_STATE_RETENTION | Detention time in days for state file | 1 |
| CRON_CLEAN_FILE_ACCESS_LOG_RETENTION | Detention time in days for access log | 365 |
| CRON_CLEAN_FILE_APPLICATION_LOG_RETENTION | Detention time in days for application log | 365 |
| CRON_CLEAN_FILE_HEALTHCHECK_LOG_RETENTION | Detention time in days for healthcheck log | 30 |

## Command to set volume permissions (non root image docker)

```sh
docker compose run --rm --entrypoint "" --user root enrich chown -R node /usr/src/app/log
docker compose run --rm --entrypoint "" --user root enrich chown -R node /usr/src/app/data
```

## Activity diagram

Enrich process

![Activity-diagram](./docs/activity-diagram-enrich.png)

### Data

3 types of file is generated by enrich job :
- uploaded file
- enriched file
- states of enrich process

They are structured like this
```
data
├── enriched
│   ├── user01
|   |   ├── 00000000-0000-0000-0000-000000000001.csv
│   |   ├── 00000000-0000-0000-0000-000000000001.jsonl
│   |   └── ...
│   └── user02
│       ├── 00000000-0000-0000-0000-000000000002.csv
│       ├── 00000000-0000-0000-0000-000000000002.jsonl
│       └── ...
├── states
│   ├── user01
|   |   ├── 00000000-0000-0000-0000-000000000001.csv
│   |   ├── 00000000-0000-0000-0000-000000000001.jsonl
│   |   └── ...
│   └── user02
│       ├── 00000000-0000-0000-0000-000000000002.csv
│       ├── 00000000-0000-0000-0000-000000000002.jsonl
│       └── ...
└── upload
    ├── user01
    |   ├── 00000000-0000-0000-0000-000000000001.csv
    |   ├── 00000000-0000-0000-0000-000000000001.jsonl
    |   └── ...
    └── user02
        ├── 00000000-0000-0000-0000-000000000002.csv
        ├── 00000000-0000-0000-0000-000000000002.jsonl
        └── ...
```

### Cron

- Clean File : Deletes files generated by updates after 30 days.

## Log format

```
:date :ip :method :url :statusCode :userAgent :responseTime
```

## Open API

[open-api documentation](https://unpaywall.inist.fr/open-api?doc=enrich)

## Test

```
# Functional tests
npm run test

# Unit tests
```