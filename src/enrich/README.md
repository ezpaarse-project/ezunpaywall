# ezunpaywall-enrich

Service that enrich csv and jsonl file with unpaywall data.

## Config

To set up this service, you can use environment variables. The config is displayed at startup. Sensitive data are not displayed.

```
# if sensitive data are not updated
warn: [config]: Redis password has the default value

info: {
  "nodeEnv": "development",
  "accessLogRotate": false,
  "timezone": "Europe/Paris",
  "redis": {
    "host": "redis",
    "port": 6379,
    "password": "********"
  },
  "graphql": {
    "host": "http://graphql:3000"
  },
  "healthTimeout": 3000
}
```

## Service environment variables

| name | default | description |
| --- | --- | --- |
| NODE_ENV | development | environment of node |
| ACCESS_LOG_ROTATE | false | Set to true if you want to use access log rotation |
| TIMEZONE | Europe/Paris | timezone of app used in cron |
| REDIS_HOST | redis | redis host |
| REDIS_PORT | 6379 | redis port |
| REDIS_PASSWORD | changeme | redis password |
| GRAPHQL_HOST | http://graphql:3000 | graphql host |
| HEALTH_TIMEOUT | 3000 | timeout to query the health route |

## Activity diagram

// coming soon

### Data

2 types of file is generated by enrich job :
- uploaded file
- enriched file
- states of enrich process

They are structured like this
```
data
├── enriched
│   ├── user01
|       ├── 00000000-0000-0000-0000-000000000001.csv
│       ├── 00000000-0000-0000-0000-000000000001.jsonl
│       ├── ...
│       └── 00000000-0000-0000-0000-000000000010.csv
│   └── user02
│       ├── 00000000-0000-0000-0000-000000000001.csv
│       ├── 00000000-0000-0000-0000-000000000001.jsonl
│       ├── ...
│       └── 00000000-0000-0000-0000-000000000010.csv
├── states
│   ├── user01
|       ├── 00000000-0000-0000-0000-000000000001.csv
│       ├── 00000000-0000-0000-0000-000000000001.jsonl
│       ├── ...
│       └── 00000000-0000-0000-0000-000000000010.csv
│   └── user02
│       ├── 00000000-0000-0000-0000-000000000001.csv
│       ├── 00000000-0000-0000-0000-000000000001.jsonl
│       ├── ...
│       └── 00000000-0000-0000-0000-000000000010.csv
└── upload
    ├── user01
        ├── 00000000-0000-0000-0000-000000000001.csv
        ├── 00000000-0000-0000-0000-000000000001.jsonl
        ├── ...
        └── 00000000-0000-0000-0000-000000000010.csv
    └── user02
        ├── 00000000-0000-0000-0000-000000000001.csv
        ├── 00000000-0000-0000-0000-000000000001.jsonl
        ├── ...
        └── 00000000-0000-0000-0000-000000000010.csv
```

### Cron

One cron automatically deletes files generated by updates that are more than 30 days old. 

## Log format

```
:ip ":user" [:date[clf]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"
```